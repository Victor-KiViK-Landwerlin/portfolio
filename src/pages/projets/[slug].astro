---
// src/pages/projets/[slug].astro
import Layout from '../../layouts/Layout.astro';
import Logo from '../../components/Logo.astro';
import { getProjectBySlug, getProjects } from '../../lib/pocketbase';

export async function getStaticPaths() {
  const projects = await getProjects();
  
  const fallbackProjects = [
    { slug: "famille-dhier" },
    { slug: "inkspire" },
    { slug: "lazydocs" },
    { slug: "ijf" }
  ];
  
  const projectsToUse = projects.length > 0 ? projects : fallbackProjects;
  
  return projectsToUse.map((project) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;
let project = await getProjectBySlug(slug as string);

const fallbackData: Record<string, any> = {
  "famille-dhier": {
    title: "Famille d'Hier",
    description: "Projet individuel réalisé en MMI1 S1.\nUne direction artistique simple et symbolique : formes géométriques naïves, pictogrammes familiaux, typographies manuelles. Comme une IA du futur essayait de représenter \"la famille\" de manière universelle.",
    role: "Webdesign éditorial · Intégration HTML",
    tools: ["Figma", "Illustrator", "HTML/CSS"],
    image: "/images/famille-dhier-hero.jpg",
    images: [
      "/images/famille-dhier-1.jpg",
      "/images/famille-dhier-2.jpg",
      "/images/famille-dhier-3.jpg",
      "/images/famille-dhier-4.jpg"
    ],
    content: "Chaque élément culturel (film, livre, chanson) a été traité comme une \"preuve\" à documenter.\n\nL'objectif était de construire un système d'archives froid et analytique, où l'émotion se transforme en objet de musée.\n\nUn site éditorial pensé mobile-first, lisible et fonctionnel.\n\nLe projet raconte une idée avant tout : un discours visuel et narratif cohérent, plus qu'une démonstration technique.",
    year: "2024"
  }
};

if (!project) {
  project = fallbackData[slug as string];
}

if (!project) {
  return Astro.redirect('/404');
}

function getImageUrl(filename: string) {
  if (!filename) return '/images/placeholder.jpg';
  if (filename.startsWith('http') || filename.startsWith('/')) return filename;
  
  if (project.id && project.collectionId) {
    return `http://127.0.0.1:8090/api/files/${project.collectionId}/${project.id}/${filename}`;
  }
  
  return filename;
}

const mainImage = getImageUrl(project.image);
const galleryImages = project.images?.map((img: string) => getImageUrl(img)) || [];
---

<Layout title={project.title} currentPath={`/projets/${slug}`}>
  <!-- Hero avec titre -->
  <section class="py-16 relative overflow-hidden">
    <div class="absolute inset-0 opacity-5 pointer-events-none">
      <Logo size="xlarge" className="absolute -top-32 left-1/2 -translate-x-1/2 w-[600px] h-[600px]" />
    </div>
    
    <div class="container mx-auto max-w-6xl relative z-10 px-6">
      <h1 class="text-7xl md:text-9xl font-bold text-kivik-green text-center mb-6">
        {project.title}
      </h1>
      <div class="w-32 h-1 bg-kivik-green mx-auto"></div>
    </div>
  </section>

  <!-- Description et infos -->
  <section class="py-16 px-6">
    <div class="container mx-auto max-w-5xl">
      <div class="grid md:grid-cols-3 gap-12">
        <!-- Description principale -->
        <div class="md:col-span-2 space-y-6">
          <div class="space-y-4 text-xl text-kivik-green leading-relaxed">
            {project.description && project.description.split('\n').map((line: string) => (
              line.trim() && <p>{line}</p>
            ))}
          </div>
        </div>

        <!-- Sidebar infos -->
        <div class="space-y-8">
          {project.role && (
            <div class="bg-white border-2 border-kivik-green p-6">
              <h3 class="text-sm font-bold text-kivik-green/60 mb-3 uppercase tracking-wide">Rôle</h3>
              <p class="text-base text-kivik-green leading-relaxed">{project.role}</p>
            </div>
          )}

          {project.year && (
            <div class="bg-white border-2 border-kivik-green p-6">
              <h3 class="text-sm font-bold text-kivik-green/60 mb-3 uppercase tracking-wide">Année</h3>
              <p class="text-2xl font-bold text-kivik-green">{project.year}</p>
            </div>
          )}

          {project.tools && project.tools.length > 0 && (
            <div class="bg-white border-2 border-kivik-green p-6">
              <h3 class="text-sm font-bold text-kivik-green/60 mb-3 uppercase tracking-wide">Outils</h3>
              <div class="flex flex-wrap gap-2">
                {project.tools.map((tool: string) => (
                  <span class="px-3 py-1 bg-kivik-light/30 text-kivik-green text-sm font-medium">
                    {tool}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Image principale -->
  {mainImage && (
    <section class="py-16 px-6 bg-gradient-to-b from-white/40 to-transparent relative overflow-hidden">
      <div class="absolute -left-32 top-0 opacity-5 pointer-events-none">
        <Logo size="xlarge" className="w-[500px] h-[500px] -rotate-12" />
      </div>

      <div class="container mx-auto max-w-6xl relative z-10">
        <div class="bg-white border-4 border-kivik-green p-6 md:p-12">
          <img 
            src={mainImage}
            alt={project.title}
            class="w-full h-auto"
          />
        </div>
        
        {project.content && (
          <div class="mt-12 max-w-4xl mx-auto text-lg text-kivik-green space-y-6 leading-relaxed">
            {project.content.split('\n').map((line: string) => (
              line.trim() && <p>{line}</p>
            ))}
          </div>
        )}
      </div>
    </section>
  )}

  <!-- Galerie d'images -->
  {galleryImages.length > 0 && (
    <section class="py-16 px-6 relative overflow-hidden">
      <div class="absolute -right-32 bottom-0 opacity-5 pointer-events-none">
        <Logo size="xlarge" className="w-[500px] h-[500px] rotate-12" />
      </div>

      <div class="container mx-auto max-w-6xl relative z-10">
        <h2 class="text-4xl font-bold text-kivik-green mb-12 text-center">Galerie</h2>
        
        <div class="grid md:grid-cols-2 gap-8">
          {galleryImages.map((img: string, index: number) => (
            <div class="bg-white border-4 border-kivik-green p-4 hover:shadow-2xl transition-all hover:-translate-y-2 group">
              <img 
                src={img}
                alt={`${project.title} - Image ${index + 1}`}
                class="w-full h-auto"
              />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- CTA + Navigation -->
  <section class="py-16 px-6 pb-24">
    <div class="container mx-auto max-w-4xl">
      <div class="flex flex-col md:flex-row gap-6 justify-center items-center">
        <a 
          href="/projets"
          class="group px-8 py-4 border-2 border-kivik-green text-kivik-green text-lg font-medium hover:bg-kivik-green hover:text-white transition-all hover:scale-105 flex items-center gap-3"
        >
          <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
          </svg>
          Tous les projets
        </a>
        
        <a 
          href="/contact"
          class="group px-8 py-4 bg-kivik-green text-white text-lg font-medium hover:bg-kivik-green/90 transition-all hover:scale-105 flex items-center gap-3"
        >
          Me contacter
          <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
          </svg>
        </a>
      </div>
    </div>
  </section>
</Layout>