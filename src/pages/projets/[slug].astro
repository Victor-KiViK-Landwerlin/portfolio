---
// src/pages/projets/[slug].astro
import Layout from '../../layouts/Layout.astro';
import { getProjectBySlug, getProjects, pb } from '../../lib/pocketbase';

export async function getStaticPaths() {
  const projects = await getProjects();
  
  // Fallback si PocketBase n'est pas configuré
  const fallbackProjects = [
    { slug: "famille-dhier" },
    { slug: "inkspire" },
    { slug: "lazydocs" },
    { slug: "ijf" }
  ];
  
  const projectsToUse = projects.length > 0 ? projects : fallbackProjects;
  
  return projectsToUse.map((project) => ({
    params: { slug: project.slug },
  }));
}

const { slug } = Astro.params;

// Récupérer le projet depuis PocketBase
let project = await getProjectBySlug(slug as string);

// Données fallback si PocketBase n'est pas configuré
const fallbackData: Record<string, any> = {
  "famille-dhier": {
    title: "Famille d'Hier",
    description: "Projet individuel réalisé en MMI1 S1.\nUne direction artistique simple et symbolique : formes géométriques naïves, pictogrammes familiaux, typographies manuelles. Comme une IA du futur essayait de représenter \"la famille\" de manière universelle.",
    role: "Webdesign éditorial · Intégration HTML | outils utilisés : Figma · Illustrator · HTML/CSS",
    image: "/images/famille-dhier-hero.jpg",
    images: [
      "/images/famille-dhier-1.jpg",
      "/images/famille-dhier-2.jpg",
      "/images/famille-dhier-3.jpg",
      "/images/famille-dhier-4.jpg"
    ],
    content: "Chaque élément culturel (film, livre, chanson) a été traité comme une \"preuve\" à documenter.\n\nL'objectif était de construire un système d'archives froid et analytique, où l'émotion se transforme en objet de musée.\n\nUn site éditorial pensé mobile-first, lisible et fonctionnel.\n\nLe projet raconte une idée avant tout : un discours visuel et narratif cohérent, plus qu'une démonstration technique.",
    year: "2024"
  }
};

// Utiliser fallback si pas de projet PocketBase
if (!project) {
  project = fallbackData[slug as string];
}

if (!project) {
  return Astro.redirect('/404');
}

// Fonction pour obtenir l'URL de l'image
function getImageUrl(filename: string) {
  if (!filename) return '/images/placeholder.jpg';
  if (filename.startsWith('http') || filename.startsWith('/')) return filename;
  
  // Si on a un projet depuis PocketBase avec collectionId
  if (project.id && project.collectionId) {
    return `http://127.0.0.1:8090/api/files/${project.collectionId}/${project.id}/${filename}`;
  }
  
  return filename;
}

// Obtenir les images
const mainImage = getImageUrl(project.image);
const galleryImages = project.images?.map((img: string) => getImageUrl(img)) || [];
---

<Layout title={project.title} currentPath={`/projets/${slug}`}>
  <!-- Titre du projet -->
  <section class="py-5">
    <div class="container mx-auto max-w-6xl">
      <h1 class="text-8xl font-bold text-kivik-green text-center mb-8">
        {project.title}
      </h1>
    </div>
  </section>

  <!-- Description principale -->
  <section class="py-12 px-6">
    <div class="container mx-auto max-w-4xl">
      <div class="space-y-4 text-lg mb-8">
        {project.description && project.description.split('\n').map((line: string) => (
          line.trim() && <p class="text-kivik-green">{line}</p>
        ))}
      </div>

      {project.role && (
        <p class="text-base text-kivik-green/80 italic">
          {project.role}
        </p>
      )}

      {(project.tools || project.year) && (
        <div class="mt-6 flex flex-wrap gap-4 text-sm text-kivik-green/60">
          {project.year && <span>Année : {project.year}</span>}
          {project.tools && <span>Outils : {project.tools.join(', ')}</span>}
        </div>
      )}
    </div>
  </section>

  <!-- Image principale -->
  {mainImage && (
    <section class="py-12 px-6 bg-amber-100/30">
      <div class="container mx-auto max-w-4xl">
        <div class="relative aspect-video bg-white p-8">
          <img 
            src={mainImage}
            alt={project.title}
            class="w-full h-full object-contain"
          />
        </div>
        
        {project.content && (
          <div class="mt-8 text-lg text-kivik-green space-y-4">
            {project.content.split('\n').map((line: string) => (
              line.trim() && <p>{line}</p>
            ))}
          </div>
        )}
      </div>
    </section>
  )}

  <!-- Grille d'images -->
  {galleryImages.length > 0 && (
    <section class="py-12 px-6">
      <div class="container mx-auto max-w-6xl">
        <div class="grid md:grid-cols-2 gap-6">
          {galleryImages.map((img: string) => (
            <div class="bg-white p-4 border-2 border-kivik-green">
              <img 
                src={img}
                alt={project.title}
                class="w-full h-auto"
              />
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Bouton contact -->
  <section class="py-12 px-6 pb-20">
    <div class="container mx-auto max-w-4xl text-center">
      <a 
        href="/contact"
        class="inline-block px-8 py-3 bg-white border-2 border-kivik-green text-kivik-green font-medium rounded-none hover:bg-kivik-green hover:text-white transition-colors"
      >
        me contacter
      </a>
    </div>
  </section>
</Layout>